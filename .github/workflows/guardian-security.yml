name: DevSecOps Guardian

on: [push, pull_request]
  
jobs:
#LAYER 1 - SECRET SCAN / SCA
  Vulnerability-triage:
    runs-on: ubuntu-latest #pulls up a virtual linux machine to run tests
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 #Pulls code into linux machine to make it readable
        with:
          fetch-depth: 0 #Github only looks at most recent, 0 sets this to entire history of project

      - name: GitGuardian Scan
        uses: GitGuardian/ggshield-action@v1.27.0 #Pulls in GitGuardian engine that scans for over 400+ credential types
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }} #Secure variable that connects to private API key without showing in logs
          
      - name: Dependency Scan (Snyk)
        uses: snyk/actions/node@master # Or python
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

#Layer 2 - CODE ANALYSIS (SAST)
  static-analysis:
    needs: Vulnerability-triage #Dependency: if secret scan failed(Ex. Leaked password), this task wont start
    runs-on: ubuntu-latest
    permissions:
      security-events: write #Gives guardian permission to write findings into repo report
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript, python
      - name: Perform Analysis
        uses: github/codeql-action/analyze@v3
#Layer 3 - IaC (Cloud)
  infrastructure-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Checkov (IaC Scan)
        uses: bridgecrewio/checkov-action@master
        with:
          direction: .
          framework: dockerfile, github_actions
#Layer 4 - Dependency Audit (Prevents members from adding libraries with high vulnerabilities
  dependency-audit:
     runs-on: ubunutu-latest
     steps:
       - name: Checkout Repository
         uses: actions/checkout@v4
         with:
        #Only fail build for high or critical vulnerabilities
           severity-threshold: high
          #These licenses  are blocked because they could force open-source code
           deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0
  #Container Security
  container-security:
    runs-on: ubuntu-latest
    steps:
     - name: Checkout code
       uses: actions/checkout@v4

     - name: Build local Docker image
       run: docker build -t club-webapp:latest #Assembles Docker machine and takes Docketfile to build container, tagged to know which object to inspect
        #club-webapp is an image
     - name: Scan Imagge with Trivy #Trivy contains a database of CVE and compares them with Docker Image
       uses: aquasecurity/trivy-action@master
       with:
         image-ref: 'club-webapp:latest' #points Trivy to specific images we built
         format: 'table' #Format: makes output readable in Github actions logs
         exit-code: '1'
         ignore-unfixed: true #Filters "noise", often vulnerabilities are found that don't have a fix yet so we don't respond
         severity: 'CRITICAL,HIGH' #threshhold for guardian to not stop the development because of a low level risk

  gatekeeper:
    needs: [Vulnerability-triage, static-analysis, dependency-audit, container-security] #Ensures all scans finish first
    runs-on: ubuntu-latest
    if: always() #runs even if previous steps failed so failure is reported
    steps:
      - name: Shield Status
        if: ${{ !contains(needs.*.result, 'failure') }}
        run: echo " Guardian is Active. Code is Secure. "

      - name: Shield Failure
        if: ${{ contains(needs.*.result, 'failure') }}
        run: |
          echo " Security Breach Detected. Found Vulnerabilities. Deployment Blocked. "
          exit 1
          
          #Secret Orchestration(AWS Secrets Manager, HashiCorp Vault)
          #WAF(Cloud Flare)
          #Supply Chain Integrity(Sign commits with GPG Key)
